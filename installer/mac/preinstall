#!/bin/bash
exec > /tmp/oadin_preinstall.log 2>&1
set -x

# 定义当前版本
THIS_VERSION="${CI_COMMIT_TAG:-1.0.0}"

# 获取真实用户
REAL_USER="${SUDO_USER:-$USER}"
USER_HOME=$(eval echo ~$REAL_USER)
OADIN_FOLDER="$USER_HOME/Oadin"

echo "--- Oadin 安装前置检查 ---"

# 检查是否存在 oadin 命令
if command -v oadin >/dev/null 2>&1; then
    OADIN_OUTPUT=$(oadin --version 2>&1 || echo "")
    echo "当前 Oadin 版本: $OADIN_OUTPUT"
    
    if [ "$OADIN_OUTPUT" != "$THIS_VERSION" ]; then
        echo "版本不匹配，清理旧版本..."
        
        # 删除用户目录
        if [ -d "$OADIN_FOLDER" ]; then
            rm -rf "$OADIN_FOLDER"
            echo "已删除用户 Oadin 目录"
        fi
        
        # 删除旧的应用包
        if [ -d "/Applications/Oadin.app" ]; then
            rm -rf "/Applications/Oadin.app"
            echo "已删除旧的 Oadin.app"
        fi
        
        # 删除软链接
        if [ -L "/usr/local/bin/oadin" ]; then
            rm -f "/usr/local/bin/oadin"
            echo "已删除软链接"
        fi
    fi
else
    echo "未找到现有 oadin 安装"
fi

echo "--- 前置检查完成 ---"
exit 0