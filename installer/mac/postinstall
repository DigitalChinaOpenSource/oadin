#!/bin/bash
exec > /tmp/oadin_postinstall.log 2>&1
set -x

# 获取真实用户（避免 sudo 环境下的问题）
REAL_USER="${SUDO_USER:-$USER}"
USER_HOME=$(eval echo ~$REAL_USER)

# 应用安装路径
APP_BUNDLE="/Applications/Oadin.app"
MACOS_DIR="${APP_BUNDLE}/Contents/MacOS"

echo "Starting Oadin postinstall process..."

# 创建用户 Oadin 目录（用于数据存储）
mkdir -p "$USER_HOME/Oadin"
chown -R "$REAL_USER:staff" "$USER_HOME/Oadin"

# 确保 /usr/local/bin 目录存在
mkdir -p /usr/local/bin

# 创建软链接到 /usr/local/bin
if [ -f "${MACOS_DIR}/oadin" ]; then
    ln -sf "${MACOS_DIR}/oadin" /usr/local/bin/oadin
    echo "Created symlink: /usr/local/bin/oadin -> ${MACOS_DIR}/oadin"
else
    echo "Warning: oadin executable not found in ${MACOS_DIR}"
fi

# 确保权限正确
chmod +x "${APP_BUNDLE}/Contents/MacOS/oadin"
chmod +x "${APP_BUNDLE}/Contents/MacOS/oadin-tray"

# 启动 oadin-tray (作为登录项)
open "${APP_BUNDLE}"

echo "Oadin installation completed successfully"
exit 0