#!/bin/bash
exec > /tmp/oadin_postinstall.log 2>&1 # 将日志重定向到 /tmp 以便调试
set -x

INSTALL_USER=$(stat -f%Su /dev/console)
USER_HOME=$(eval echo "~$INSTALL_USER")
mkdir -p "$USER_HOME/Oadin"
set -x
cp -f /Users/Shared/Oadin/oadin "$USER_HOME/Oadin/oadin"
ln -sf "$USER_HOME/Oadin/oadin" /usr/local/bin/oadin
SHELL_PATH=$(dscl . -read /Users/$INSTALL_USER UserShell | awk '{print $2}')
SHELL_NAME=$(basename "$SHELL_PATH")

if [ "$SHELL_NAME" = "zsh" ]; then
  RC_FILE="$USER_HOME/.zshrc"
elif [ "$SHELL_NAME" = "bash" ]; then
  RC_FILE="$USER_HOME/.bash_profile"
else
  RC_FILE=""
fi


if [ -n "$RC_FILE" ] && [ -f "$RC_FILE" ]; then
  su - "$INSTALL_USER" -c "source $RC_FILE && oadin server start -d"
else
  su - "$INSTALL_USER" -c "oadin server start -d"
fi