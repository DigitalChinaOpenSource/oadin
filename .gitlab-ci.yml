stages:
  - build_mac
  - upload_mac
  - build_win
  - upload_win

variables:
  GIT_STRATEGY: none
  MAC_FILE_NAME: "byze-installer-${CI_COMMIT_TAG}.pkg"
  WIN_FILE_NAME: "byze-installer-${CI_COMMIT_TAG}.exe"


build_mac:
  stage: build_mac
  tags:
    - aipc-mac
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(test|[0-9]+\.)/'
  script:
    - echo "========== ğŸ”§ Mac Build Begin =========="
    - echo "--------- ğŸ§¹ æ¸…é™¤æ—§æ–‡ä»¶ å‡†å¤‡çº¯å‡€ç¯å¢ƒ ----------"
    - cd /Users/dcone/WebstormProjects/byze/
    - git reset --hard
    - git clean -fd
    - echo "--------- ğŸ”– æ‹‰å–ä»£ç å‡†å¤‡æ„å»º ----------"
    - git fetch
    - echo $CI_COMMIT_TAG ; git checkout $CI_COMMIT_TAG
    - echo "--------- ğŸ› ï¸ åˆ¶å“æ„å»ºä¸ç­¾å ----------"
    - go mod tidy
    - CGO_ENABLED=1 GOOS=darwin GOARCH=arm64  go build -o byze -ldflags="-s -w"  cmd/cli/main.go
    - export APPLE_ID="it@digitalchina.com"
    - export APPLE_APP_SPECIFIC_PASSWORD="yyzx-tium-divi-iors"
    - export APPLE_TEAM_ID="US7ZG73N89"
    - export CSC_LINK="./Developer ID Application.p12"
    - export CSC_KEY_PASSWORD=".=ZWwByOvD|gtA-8_c#cbim@+B23(K8s"
    - export CSC_INSTALLER_LINK="./Developer ID Installer.p12"
    - export CSC_INSTALLER_KEY_PASSWORD="k-RyN2ggMwLYx<Hb?Lw(OVu49Z-4V1SM"
    - |  
      codesign --verbose --force  --timestamp --options=runtime --sign "Developer ID Application: Digital China (China) Limited (US7ZG73N89)" byze
    - echo "--------- ğŸ“¦ å®‰è£…åŒ…æ„å»ºä¸ç­¾å ----------"
    - mkdir -p pkgroot/bin
    - mv byze pkgroot/bin/byze
    - mkdir -p scripts
    - echo '#!/bin/bash' > scripts/postinstall
    - echo 'ln -sf /usr/local/bin/byze /bin/byze' >> scripts/postinstall
    - echo '/usr/local/bin/byze server start -d' >> scripts/postinstall
    - chmod +x scripts/postinstall
    - |
      pkgbuild --identifier com.digitalchina.byze --version "${CI_COMMIT_TAG}" --install-location /usr/local/bin --sign "Developer ID Installer: Digital China (China) Limited (US7ZG73N89)" --root pkgroot/bin --scripts ./scripts byze.pkg
    - echo "--------- ğŸ“¬ å®‰è£…åŒ…å…¬è¯ ----------"
    - xcrun notarytool store-credentials "ci-profile" --apple-id "$APPLE_ID" --team-id "$APPLE_TEAM_ID"  --password "$APPLE_APP_SPECIFIC_PASSWORD"
    - xcrun notarytool submit byze.pkg --keychain-profile "ci-profile" --wait
    - echo "--------- ğŸ“ é™„åŠ å…¬è¯ç¥¨æ® ----------"
    - xcrun stapler staple byze.pkg
    - echo "--------- ğŸ”ï¸ éªŒç­¾ ----------"
    - spctl --assess --type install --verbose=4 byze.pkg
    - echo "--------- ğŸ“ ç§»åŠ¨åˆ°å¾…ä¸Šä¼ æ–‡ä»¶å¤¹ ----------"
    - mkdir -p upload
    - mv byze.pkg upload/${MAC_FILE_NAME}
    - echo "========== ğŸ”§ Mac Build End =========="

upload_to_nexus_mac:
  stage: upload_mac
  tags:
    - aipc-mac
  rules:
    - if: '$CI_COMMIT_TAG =~ /^test/'
  script:
    - echo "========== ğŸ”§ Mac Upload Begin =========="
    - echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° Nexus ç§æœ --------"
    - |
      curl -v -u "admin:${NEXUS_PASSWORD}" --upload-file "/Users/dcone/WebstormProjects/byze/upload/${MAC_FILE_NAME}" "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/byze/releases/mac/${MAC_FILE_NAME}"
      curl -v -u "admin:${NEXUS_PASSWORD}" --upload-file "/Users/dcone/WebstormProjects/byze/upload/${MAC_FILE_NAME}" "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/byze/releases/mac/byze-installer-latest.pkg"
    - echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
    - cd /Users/dcone/WebstormProjects/byze
    - git reset --hard
    - git clean -fd
    - echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
    - git checkout main
    - git tag -d $CI_COMMIT_TAG
    - echo "--------- ğŸ”—ï¸ åˆ¶å“ä¸‹è½½åœ°å€ ----------"
    - echo "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/byze/releases/mac/${MAC_FILE_NAME}"
    - echo "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/byze/releases/mac/byze-installer-latest.pkg"
    - echo "========== ğŸ”§ Mac Upload End =========="

upload_to_oss_mac:
  stage: upload_mac
  tags:
    - aipc-mac
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[0-9]+\./'
  script:
    - echo "========== ğŸ”§ Mac Upload Begin =========="
    - echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° é˜¿é‡Œäº‘ OSS --------"
    - cd /Users/dcone/WebstormProjects/byze/upload
    - ossutil cp "${MAC_FILE_NAME}" "oss://smartvision-aipc/byze/releases/macos/${MAC_FILE_NAME}" --force
    - ossutil cp "${MAC_FILE_NAME}" "oss://smartvision-aipc/byze/releases/macos/byze-installer-latest.pkg" --force
    - echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
    - git reset --hard
    - git clean -fd
    - echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
    - git checkout main
    - git tag -d $CI_COMMIT_TAG
    - echo "--------- â™»ï¸ åˆ·æ–°CND ----------"
    - aliyun cdn RefreshObjectCaches --ObjectPath "https://oss-aipc.dcclouds.com/byze/releases/macos/byze-installer-latest.pkg" --ObjectType File
    - echo "--------- ğŸ”—ï¸ åˆ¶å“ä¸‹è½½åœ°å€ ----------"
    - echo "https://oss-aipc.dcclouds.com/byze/releases/macos/${MAC_FILE_NAME}"
    - echo "https://oss-aipc.dcclouds.com/byze/releases/macos/byze-installer-latest.pkg"
    - echo "========== ğŸ”§ Mac Upload End =========="


build_win:
  stage: build_win
  tags:
    - aipc-win
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(test|[0-9]+\.)/'
  script:
    - chcp 65001 > $null
    - $OutputEncoding = [System.Text.Encoding]::UTF8
    - |
      [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
    - echo "========== ğŸ”§ Win Build Begin =========="
    - echo "--------- ğŸ§¹ æ¸…é™¤æ—§æ–‡ä»¶ å‡†å¤‡çº¯å‡€ç¯å¢ƒ ----------"
    - cd C:\Users\Administrator\WebstormProjects\byze
    - git reset --hard
    - git clean -fd
    - echo "--------- ğŸ”– æ‹‰å–ä»£ç å‡†å¤‡æ„å»º ----------"
    - git fetch
    - echo $env:CI_COMMIT_TAG ; git checkout $env:CI_COMMIT_TAG
    - echo "--------- ğŸ› ï¸ åˆ¶å“æ„å»ºä¸ç­¾å ----------"
    - go mod tidy
    - $env:CGO_ENABLED= 1
    - $env:GOOS= "windows"
    - $env:GOARCH= "amd64"
    - go build -o byze.exe -ldflags="-s -w"  cmd/cli/main.go
    - signtool sign /f C:\Users\Administrator\Desktop\u.cer /tr http://timestamp.digicert.com /td sha256 /fd sha256 /csp "eToken Base Cryptographic Provider" /k "[{{$($WIN_SIGN_PASSWORD)}}]=p11#942acfc7f5754f2e" "byze.exe"
    - echo "--------- ğŸ“¦ å®‰è£…åŒ…æ„å»ºä¸ç­¾å ----------"
    - cd installer ; makensis.exe -DVERSION=$env:CI_COMMIT_TAG byze.nsi
    - cd .. ; signtool sign /f C:\Users\Administrator\Desktop\u.cer /tr http://timestamp.digicert.com /td sha256 /fd sha256 /csp "eToken Base Cryptographic Provider" /k "[{{$($WIN_SIGN_PASSWORD)}}]=p11#942acfc7f5754f2e" "byze-installer.exe"
    - echo "--------- ğŸ“ ç§»åŠ¨åˆ°å¾…ä¸Šä¼ æ–‡ä»¶å¤¹ ----------"
    - New-Item -ItemType Directory -Path "upload" -Force
    - Move-Item -Path "byze-installer.exe" -Destination "upload\$($env:WIN_FILE_NAME)" -Force
    - echo "========== ğŸ”§ Win Build End =========="

upload_to_nexus_win:
  stage: upload_win
  tags:
    - aipc-win
  rules:
    - if: '$CI_COMMIT_TAG =~ /^test/'
  script:
    - chcp 65001 > $null
    - $OutputEncoding = [System.Text.Encoding]::UTF8
    - |
      [ Console ]::OutputEncoding = [System.Text.Encoding]::UTF8
    - echo "========== ğŸ”§ Win Upload Begin =========="
    - echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° Nexus ç§æœ --------"
    - cd C:\Users\Administrator\WebstormProjects\byze
    - curl.exe -v -u "admin:$($env:NEXUS_PASSWORD)" --upload-file "upload/$($env:WIN_FILE_NAME)" "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/byze/releases/win/$($env:WIN_FILE_NAME)"
    - curl.exe -v -u "admin:$($env:NEXUS_PASSWORD)" --upload-file "upload/$($env:WIN_FILE_NAME)" "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/byze/releases/win/byze-installer-latest.exe"
    - echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
    - git reset --hard
    - git clean -fd
    - echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
    - git checkout main
    - git tag -d $env:CI_COMMIT_TAG
    - echo "--------- ğŸ”—ï¸ åˆ¶å“ä¸‹è½½åœ°å€ ----------"
    - echo "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/byze/releases/win/$($env:WIN_FILE_NAME)"
    - echo "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/byze/releases/win/byze-installer-latest.exe"
    - echo "========== ğŸ”§ Win Upload End =========="


upload_to_oss_win:
  stage: upload_win
  tags:
    - aipc-win
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[0-9]+\./'
  script:
    - chcp 65001 > $null
    - $OutputEncoding = [System.Text.Encoding]::UTF8
    - |
      [ Console ]::OutputEncoding = [System.Text.Encoding]::UTF8
    - echo "========== ğŸ”§ Win Upload Begin =========="
    - echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° é˜¿é‡Œäº‘ OSS --------"
    - cd C:\Users\Administrator\WebstormProjects\byze
    - ossutil cp "upload/$($env:WIN_FILE_NAME)" "oss://smartvision-aipc/byze/releases/windows/$($env:WIN_FILE_NAME)" --force
    - ossutil cp "upload/$($env:WIN_FILE_NAME)" "oss://smartvision-aipc/byze/releases/windows/byze-installer-latest.exe" --force
    - echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
    - git reset --hard
    - git clean -fd
    - echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
    - git checkout main
    - git tag -d $env:CI_COMMIT_TAG
    - echo "--------- â™»ï¸ åˆ·æ–°CND ----------"
    - aliyun cdn RefreshObjectCaches --ObjectPath "https://oss-aipc.dcclouds.com/byze/releases/windows/byze-installer-latest.exe" --ObjectType File
    - echo "--------- ğŸ”—ï¸ åˆ¶å“ä¸‹è½½åœ°å€ ----------"
    - echo "https://oss-aipc.dcclouds.com/byze/releases/windows/$($env:WIN_FILE_NAME)"
    - echo "https://oss-aipc.dcclouds.com/byze/releases/windows/byze-installer-latest.exe"
    - echo "========== ğŸ”§ Win Upload End =========="