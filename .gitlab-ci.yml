stages:
  - build_mac
  - upload_mac
  - build_win
  - upload_win

variables:
  GIT_STRATEGY: none
  ENV: "production"
  MAC_FILE_NAME: "oadin-installer-${CI_COMMIT_TAG}.pkg"
  WIN_FILE_NAME: "oadin-installer-${CI_COMMIT_TAG}.exe"


build_mac:
  stage: build_mac
  tags:
    - aipc-mac
  rules:
    - if: '$CI_COMMIT_TAG =~ /^test/'
      variables:
        ENV: "development"
    - if: '$CI_COMMIT_TAG =~ /^[0-9]+\./'
      variables:
        ENV: "production"
    - when: never
  script:
    - echo "========== ğŸ”§ Mac Build Begin =========="
    - echo "--------- ğŸ§¹ æ¸…é™¤æ—§æ–‡ä»¶ å‡†å¤‡çº¯å‡€ç¯å¢ƒ ----------"
    - cd /Users/dcone/WebstormProjects/byze/
    - git reset --hard
    - git clean -fd
    - echo "--------- ğŸ”– æ‹‰å–ä»£ç å‡†å¤‡æ„å»º ----------"
    - git fetch
    - echo $CI_COMMIT_TAG ; git checkout $CI_COMMIT_TAG
    - echo "--------- ğŸ› ï¸ åˆ¶å“æ„å»ºä¸ç­¾å ----------"
    - go mod tidy
    - echo "$ENV active"
    - CGO_ENABLED=1 CGO_CFLAGS="-I$PWD\internal\datastore\sqlite\sqlite-vec" GOOS=darwin GOARCH=arm64  go build -o oadin -tags "$ENV" -ldflags="-s -w"  cmd/cli/main.go
    - export APPLE_ID="it@digitalchina.com"
    - export APPLE_APP_SPECIFIC_PASSWORD="yyzx-tium-divi-iors"
    - export APPLE_TEAM_ID="US7ZG73N89"
    - export CSC_LINK="./Developer ID Application.p12"
    - export CSC_KEY_PASSWORD=".=ZWwByOvD|gtA-8_c#cbim@+B23(K8s"
    - export CSC_INSTALLER_LINK="./Developer ID Installer.p12"
    - export CSC_INSTALLER_KEY_PASSWORD="k-RyN2ggMwLYx<Hb?Lw(OVu49Z-4V1SM"
    - |  
      codesign --verbose --force  --timestamp --options=runtime --sign "Developer ID Application: Digital China (China) Limited (US7ZG73N89)" oadin
    - echo "--------- ğŸ“¦ å®‰è£…åŒ…æ„å»ºä¸ç­¾å ----------"
    - mkdir -p pkgroot/oadin
    - mv oadin pkgroot/oadin/oadin
    - mkdir -p scripts
    - echo '#!/bin/bash' > scripts/postinstall
    - echo 'USER_HOME=$(eval echo ~${SUDO_USER:-$USER})' >> scripts/postinstall
    - echo 'mkdir -p "$USER_HOME/Oadin"' >> scripts/postinstall
    - echo 'set -x' >> scripts/postinstall
    - echo 'cp -f /Users/Shared/Oadin/oadin "$USER_HOME/Oadin/oadin"' >> scripts/postinstall
    - echo 'ln -sf "$USER_HOME/Oadin/oadin" /usr/local/bin/oadin' >> scripts/postinstall
    - echo "SHELL_PATH=$(dscl . -read /Users/$USER UserShell | awk '{print $2}')" >> scripts/postinstall
    - echo 'SHELL_NAME=$(basename "$SHELL_PATH")' >> scripts/postinstall
    - echo 'if [ "$SHELL_NAME" = "zsh" ]; then' >> scripts/postinstall
    - echo '  RC_FILE="$USER_HOME/.zshrc"' >> scripts/postinstall
    - echo 'elif [ "$SHELL_NAME" = "bash" ]; then' >> scripts/postinstall
    - echo '  RC_FILE="$USER_HOME/.bash_profile"' >> scripts/postinstall
    - echo 'else' >> scripts/postinstall
    - echo '  RC_FILE=""' >> scripts/postinstall
    - echo 'fi' >> scripts/postinstall
    - echo 'echo "USER=$USER_HOME" >> $USER_HOME/test.txt' >> scripts/postinstall
    - echo 'echo "SHELL_PATH=$SHELL_PATH" >> $USER_HOME/test.txt' >> scripts/postinstall
    - echo 'echo "SHELL_NAME=$SHELL_NAME" >> $USER_HOME/test.txt' >> scripts/postinstall
    - echo 'echo "RC_FILE=$RC_FILE" >> $USER_HOME/test.txt' >> scripts/postinstall
    - echo 'if [ -n "$RC_FILE" ] && [ -f "$RC_FILE" ]; then' >> scripts/postinstall
    - echo '  echo 1111 >> $USER_HOME/test.txt' >> scripts/postinstall
    - echo '  su - "$USER" -c "source $RC_FILE && oadin server start -d"' >> scripts/postinstall
    - echo 'else' >> scripts/postinstall
    - echo '  echo 2222 >> $USER_HOME/test.txt' >> scripts/postinstall
    - echo '  su - "$USER" -c "oadin server start -d"' >> scripts/postinstall
    - echo 'fi' >> scripts/postinstall
    - chmod +x scripts/postinstall
    - |
      pkgbuild --identifier com.digitalchina.oadin --version "${CI_COMMIT_TAG}" --install-location /Users/Shared/Oadin --sign "Developer ID Installer: Digital China (China) Limited (US7ZG73N89)" --root pkgroot/Oadin --scripts ./scripts oadin.pkg
    - echo "--------- ğŸ“¬ å®‰è£…åŒ…å…¬è¯ ----------"
    - xcrun notarytool store-credentials "ci-profile" --apple-id "$APPLE_ID" --team-id "$APPLE_TEAM_ID"  --password "$APPLE_APP_SPECIFIC_PASSWORD"
    - xcrun notarytool submit oadin.pkg --keychain-profile "ci-profile" --wait
    - echo "--------- ğŸ“ é™„åŠ å…¬è¯ç¥¨æ® ----------"
    - xcrun stapler staple oadin.pkg
    - echo "--------- ğŸ”ï¸ éªŒç­¾ ----------"
    - spctl --assess --type install --verbose=4 oadin.pkg
    - echo "--------- ğŸ“ ç§»åŠ¨åˆ°å¾…ä¸Šä¼ æ–‡ä»¶å¤¹ ----------"
    - mkdir -p upload
    - mv oadin.pkg upload/${MAC_FILE_NAME}
    - echo "========== ğŸ”§ Mac Build End =========="

upload_to_nexus_mac:
  stage: upload_mac
  tags:
    - aipc-mac
  rules:
    - if: '$CI_COMMIT_TAG =~ /^test/'
  script:
    - echo "========== ğŸ”§ Mac Upload Begin =========="
    - echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° Nexus ç§æœ --------"
    - |
      curl -v -u "admin:${NEXUS_PASSWORD}" --upload-file "/Users/dcone/WebstormProjects/byze/upload/${MAC_FILE_NAME}" "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/oadin/releases/mac/${MAC_FILE_NAME}"
      curl -v -u "admin:${NEXUS_PASSWORD}" --upload-file "/Users/dcone/WebstormProjects/byze/upload/${MAC_FILE_NAME}" "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/oadin/releases/mac/oadin-installer-latest.pkg"
    - echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
    - cd /Users/dcone/WebstormProjects/byze
    - git reset --hard
    - git clean -fd
    - echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
    - git checkout main
    - git tag -d $CI_COMMIT_TAG
    - echo "--------- ğŸ”—ï¸ åˆ¶å“ä¸‹è½½åœ°å€ ----------"
    - echo "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/oadin/releases/mac/${MAC_FILE_NAME}"
    - echo "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/oadin/releases/mac/oadin-installer-latest.pkg"
    - echo "========== ğŸ”§ Mac Upload End =========="

upload_to_oss_mac:
  stage: upload_mac
  tags:
    - aipc-mac
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[0-9]+\./'
  script:
    - echo "========== ğŸ”§ Mac Upload Begin =========="
    - echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° é˜¿é‡Œäº‘ OSS --------"
    - cd /Users/dcone/WebstormProjects/byze/upload
    - ossutil cp "${MAC_FILE_NAME}" "oss://smartvision-aipc/oadin/releases/macos/${MAC_FILE_NAME}" --force
    - ossutil cp "${MAC_FILE_NAME}" "oss://smartvision-aipc/oadin/releases/macos/oadin-installer-latest.pkg" --force
    - echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
    - git reset --hard
    - git clean -fd
    - echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
    - git checkout main
    - git tag -d $CI_COMMIT_TAG
    - echo "--------- â™»ï¸ åˆ·æ–°CND ----------"
    - aliyun cdn RefreshObjectCaches --ObjectPath "https://oss-aipc.dcclouds.com/oadin/releases/macos/oadin-installer-latest.pkg" --ObjectType File
    - echo "--------- ğŸ”—ï¸ åˆ¶å“ä¸‹è½½åœ°å€ ----------"
    - echo "https://oss-aipc.dcclouds.com/oadin/releases/macos/${MAC_FILE_NAME}"
    - echo "https://oss-aipc.dcclouds.com/oadin/releases/macos/oadin-installer-latest.pkg"
    - echo "========== ğŸ”§ Mac Upload End =========="


build_win:
  stage: build_win
  tags:
    - aipc-win
  rules:
    - if: '$CI_COMMIT_TAG =~ /^test/'
      variables:
        ENV: "development"
    - if: '$CI_COMMIT_TAG =~ /^[0-9]+\./'
      variables:
        ENV: "production"
    - when: never
  script:
    - chcp 65001 > $null
    - $OutputEncoding = [System.Text.Encoding]::UTF8
    - |
      [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
    - echo "========== ğŸ”§ Win Build Begin =========="
    - echo "--------- ğŸ§¹ æ¸…é™¤æ—§æ–‡ä»¶ å‡†å¤‡çº¯å‡€ç¯å¢ƒ ----------"
    - cd C:\Users\Administrator\WebstormProjects\byze
    - git reset --hard
    - git clean -fd
    - echo "--------- ğŸ”– æ‹‰å–ä»£ç å‡†å¤‡æ„å»º ----------"
    - git fetch
    - echo $env:CI_COMMIT_TAG ; git checkout $env:CI_COMMIT_TAG
    - echo "--------- ğŸ› ï¸ åˆ¶å“æ„å»ºä¸ç­¾å ----------"
    - go mod tidy
    - $env:CGO_ENABLED= 1
    - $env:GOOS= "windows"
    - $env:GOARCH= "amd64"
    - $env:CGO_CFLAGS= "-I$PWD\internal\datastore\sqlite\sqlite-vec"
    - echo "$env:ENV active"
    - go build -o oadin.exe -tags "$env:ENV" -ldflags="-s -w"  cmd/cli/main.go
    - signtool sign /f C:\Users\Administrator\Desktop\u.cer /tr http://timestamp.digicert.com /td sha256 /fd sha256 /csp "eToken Base Cryptographic Provider" /k "[{{$($WIN_SIGN_PASSWORD)}}]=p11#942acfc7f5754f2e" "oadin.exe"
    - echo "--------- ğŸ“¦ å®‰è£…åŒ…æ„å»ºä¸ç­¾å ----------"
    - cd installer ; makensis.exe -DVERSION=$env:CI_COMMIT_TAG oadin.nsi
    - cd .. ; signtool sign /f C:\Users\Administrator\Desktop\u.cer /tr http://timestamp.digicert.com /td sha256 /fd sha256 /csp "eToken Base Cryptographic Provider" /k "[{{$($WIN_SIGN_PASSWORD)}}]=p11#942acfc7f5754f2e" "oadin-installer.exe"
    - echo "--------- ğŸ“ ç§»åŠ¨åˆ°å¾…ä¸Šä¼ æ–‡ä»¶å¤¹ ----------"
    - New-Item -ItemType Directory -Path "upload" -Force
    - Move-Item -Path "oadin-installer.exe" -Destination "upload\$($env:WIN_FILE_NAME)" -Force
    - echo "========== ğŸ”§ Win Build End =========="

upload_to_nexus_win:
  stage: upload_win
  tags:
    - aipc-win
  rules:
    - if: '$CI_COMMIT_TAG =~ /^test/'
  script:
    - chcp 65001 > $null
    - $OutputEncoding = [System.Text.Encoding]::UTF8
    - |
      [ Console ]::OutputEncoding = [System.Text.Encoding]::UTF8
    - echo "========== ğŸ”§ Win Upload Begin =========="
    - echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° Nexus ç§æœ --------"
    - cd C:\Users\Administrator\WebstormProjects\byze
    - curl.exe -v -u "admin:$($env:NEXUS_PASSWORD)" --upload-file "upload/$($env:WIN_FILE_NAME)" "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/oadin/releases/win/$($env:WIN_FILE_NAME)"
    - curl.exe -v -u "admin:$($env:NEXUS_PASSWORD)" --upload-file "upload/$($env:WIN_FILE_NAME)" "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/oadin/releases/win/oadin-installer-latest.exe"
    - echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
    - git reset --hard
    - git clean -fd
    - echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
    - git checkout main
    - git tag -d $env:CI_COMMIT_TAG
    - echo "--------- ğŸ”—ï¸ åˆ¶å“ä¸‹è½½åœ°å€ ----------"
    - echo "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/oadin/releases/win/$($env:WIN_FILE_NAME)"
    - echo "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/oadin/releases/win/oadin-installer-latest.exe"
    - echo "========== ğŸ”§ Win Upload End =========="


upload_to_oss_win:
  stage: upload_win
  tags:
    - aipc-win
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[0-9]+\./'
  script:
    - chcp 65001 > $null
    - $OutputEncoding = [System.Text.Encoding]::UTF8
    - |
      [ Console ]::OutputEncoding = [System.Text.Encoding]::UTF8
    - echo "========== ğŸ”§ Win Upload Begin =========="
    - echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° é˜¿é‡Œäº‘ OSS --------"
    - cd C:\Users\Administrator\WebstormProjects\byze
    - ossutil cp "upload/$($env:WIN_FILE_NAME)" "oss://smartvision-aipc/oadin/releases/windows/$($env:WIN_FILE_NAME)" --force
    - ossutil cp "upload/$($env:WIN_FILE_NAME)" "oss://smartvision-aipc/oadin/releases/windows/oadin-installer-latest.exe" --force
    - echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
    - git reset --hard
    - git clean -fd
    - echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
    - git checkout main
    - git tag -d $env:CI_COMMIT_TAG
    - echo "--------- â™»ï¸ åˆ·æ–°CND ----------"
    - aliyun cdn RefreshObjectCaches --ObjectPath "https://oss-aipc.dcclouds.com/oadin/releases/windows/oadin-installer-latest.exe" --ObjectType File
    - echo "--------- ğŸ”—ï¸ åˆ¶å“ä¸‹è½½åœ°å€ ----------"
    - echo "https://oss-aipc.dcclouds.com/oadin/releases/windows/$($env:WIN_FILE_NAME)"
    - echo "https://oss-aipc.dcclouds.com/oadin/releases/windows/oadin-installer-latest.exe"
    - echo "========== ğŸ”§ Win Upload End =========="