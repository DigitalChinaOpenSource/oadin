stages:
  - build
  - upload

variables:
  GIT_STRATEGY: none
  MAC_FILE_NAME: "byze-${CI_COMMIT_TAG}"
  WIN_FILE_NAME: "byze-${CI_COMMIT_TAG}.exe"


# ÊµãËØïÁéØÂ¢É
build_mac_test:
  stage: build
  tags:
    - aipc-mac
  rules:
    - if: '$CI_COMMIT_TAG =~ /^test/'
  script:
    - echo "üîß Mac ÊûÑÂª∫"
    - cd /Users/dcone/WebstormProjects/byze/
    - git reset --hard
    - git clean -fd
    - git fetch
    - echo $CI_COMMIT_TAG
    - git checkout $CI_COMMIT_TAG
    - go mod tidy
    - CGO_ENABLED=1 GOOS=darwin GOARCH=amd64  go build -o byze -ldflags="-s -w"  cmd/cli/main.go
    - mkdir -p upload
    - mv byze upload/${MAC_FILE_NAME}

# ÊµãËØïÁéØÂ¢É
build_win_test:
  stage: build
  tags:
    - aipc-win
  rules:
    - if: '$CI_COMMIT_TAG =~ /^test/'
  script:
    - echo "üîß Win ÊûÑÂª∫"
    - cd C:\Users\Administrator\WebstormProjects\byze
    - git reset --hard
    - git clean -fd
    - git fetch
    - echo $env:CI_COMMIT_TAG
    - git checkout $env:CI_COMMIT_TAG
    - go mod tidy
    - go build -o byze.exe -ldflags="-s -w"  cmd/cli/main.go
    - signtool sign /f C:\Users\Administrator\Desktop\u.cer /tr http://timestamp.digicert.com /td sha256 /fd sha256 /csp "eToken Base Cryptographic Provider" /k "[{{$($WIN_SIGN_PASSWORD)}}]=p11#942acfc7f5754f2e" "C:\Users\Administrator\WebstormProjects\byze\byze.exe"
    - New-Item -ItemType Directory -Path "upload" -Force
    - Move-Item -Path "byze.exe" -Destination "upload\$($env:WIN_FILE_NAME)" -Force

upload_to_nexus_mac:
  stage: upload
  tags:
    - aipc-mac
  rules:
    - if: '$CI_COMMIT_TAG =~ /^test/'
  script:
    - echo "üì§ ‰∏ä‰º†Âà∞ Nexus ‰ªìÂ∫ì"
    - |
      curl -v -u "admin:${NEXUS_PASSWORD}" \
        --upload-file "/Users/dcone/WebstormProjects/byze/upload/${MAC_FILE_NAME}" \
        "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/byze/releases/mac/${MAC_FILE_NAME}"
    - cd /Users/dcone/WebstormProjects/byze
    - git reset --hard
    - git clean -fd
    - git checkout main
    - git tag -d $CI_COMMIT_TAG

upload_to_nexus_win:
  stage: upload
  tags:
    - aipc-win
  rules:
    - if: '$CI_COMMIT_TAG =~ /^test/'
  script:
    - echo "üì§ ‰∏ä‰º†Âà∞ Nexus ‰ªìÂ∫ì"
    - cd C:\Users\Administrator\WebstormProjects\byze\
    - curl.exe -v -u "admin:$($env:NEXUS_PASSWORD)" --upload-file "upload/$($env:WIN_FILE_NAME)" "http://10.3.70.145:32018/repository/raw-hosted/intel-ai-pc/byze/releases/win/$($env:WIN_FILE_NAME)"
    - git reset --hard
    - git clean -fd
    - git checkout main
    - git tag -d $env:CI_COMMIT_TAG






# Áîü‰∫ßÁéØÂ¢É
build_mac_prod:
  stage: build
  tags:
    - aipc-mac
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[0-9]+\./'
  script:
    - echo "üîß Mac ÊûÑÂª∫"
    - cd /Users/dcone/WebstormProjects/byze/
    - git reset --hard
    - git clean -fd
    - git fetch
    - echo $CI_COMMIT_TAG
    - git checkout $CI_COMMIT_TAG
    - go mod tidy
    - CGO_ENABLED=1 GOOS=darwin GOARCH=amd64  go build -o byze -ldflags="-s -w"  cmd/cli/main.go
    - mkdir -p upload
    - mv byze upload/${MAC_FILE_NAME}

# Áîü‰∫ßÁéØÂ¢É
build_win_prod:
  stage: build
  tags:
    - aipc-win
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[0-9]+\./'
  script:
    - echo "üîß Win ÊûÑÂª∫"
    - cd C:\Users\Administrator\WebstormProjects\byze
    - git reset --hard
    - git clean -fd
    - git fetch
    - echo $env:CI_COMMIT_TAG
    - git checkout $env:CI_COMMIT_TAG
    - go mod tidy
    - go build -o byze.exe -ldflags="-s -w"  cmd/cli/main.go
    - signtool sign /f C:\Users\Administrator\Desktop\u.cer /tr http://timestamp.digicert.com /td sha256 /fd sha256 /csp "eToken Base Cryptographic Provider" /k "[{{$($WIN_SIGN_PASSWORD)}}]=p11#942acfc7f5754f2e" "C:\Users\Administrator\WebstormProjects\byze\byze.exe"
    - New-Item -ItemType Directory -Path "upload" -Force
    - Move-Item -Path "byze.exe" -Destination "upload\$($env:WIN_FILE_NAME)" -Force

upload_to_oss_mac:
  stage: upload
  tags:
    - aipc-mac
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[0-9]+\./'
  script:
    - echo "üì§ ‰∏ä‰º†Âà∞ ÈòøÈáå‰∫ëoss"
    - cd /Users/dcone/WebstormProjects/byze/upload
    - ossutil cp "${MAC_FILE_NAME}" "oss://smartvision-aipc/byze/releases/macos/${MAC_FILE_NAME}" --force
    - ossutil cp "${MAC_FILE_NAME}" "oss://smartvision-aipc/byze/releases/macos/byze-latest" --force
    - echo "‚úÖ ‰∏ä‰º†ÂÆåÊàê"
    - git reset --hard
    - git clean -fd
    - git checkout main
    - git tag -d $CI_COMMIT_TAG

upload_to_oss_win:
  stage: upload
  tags:
    - aipc-win
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[0-9]+\./'
  script:
    - echo "üì§ ‰∏ä‰º†Âà∞ ÈòøÈáå‰∫ëoss"
    - cd C:\Users\Administrator\WebstormProjects\byze\upload
    - ossutil cp "$($env:WIN_FILE_NAME)" "oss://smartvision-aipc/byze/releases/windows/$($env:WIN_FILE_NAME)" --force
    - ossutil cp "$($env:WIN_FILE_NAME)" "oss://smartvision-aipc/byze/releases/windows/byze-latest.exe" --force
    - echo "‚úÖ ‰∏ä‰º†ÂÆåÊàê"
    - git reset --hard
    - git clean -fd
    - git checkout main
    - git tag -d $env:CI_COMMIT_TAG