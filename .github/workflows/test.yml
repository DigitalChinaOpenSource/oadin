name: test workflow

on:
  workflow_dispatch:
    inputs:
      version:
        required: true
      branch:
        default: oadin-2.0.0/ci
        required: true

env:
  # æ ¹æ®è§¦å‘æ–¹å¼ä½¿ç”¨ä¸åŒçš„æ ‡è¯†ç¬¦
  VERSION: ${{ github.event.inputs.version }}
  BRANCH: ${{ github.event.inputs.branch }}
  MAC_FILE_NAME: "oadin-installer-${{ github.event.inputs.version }}.pkg"
  WIN_FILE_NAME: "oadin-installer-${{ github.event.inputs.version }}.exe"
  NEXUS_HOST_PORT: ${{ secrets.NEXUS_HOST_PORT }}
  NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
  NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
  HOOK_BRIDGE_URL: ${{ secrets.HOOK_BRIDGE_URL }}
  PROJECT_FLAG: ${{ secrets.PROJECT_FLAG }}

jobs:
  build-mac:
    name: Build macOS App
    runs-on: [ self-hosted, macOS, ARM64 ]
    steps:
      - name: Set ENV based on tag
        run: |
          echo "ENV=development" >> $GITHUB_ENV
      - name: Run build script on Mac
        run: |
          echo "========== ğŸ”§ Mac Build Begin =========="
          echo "--------- ğŸ§¹ æ¸…é™¤æ—§æ–‡ä»¶ å‡†å¤‡çº¯å‡€ç¯å¢ƒ ----------"
          cd /Users/dcone/WebstormProjects/oadin/
          git reset --hard
          git clean -fd
          echo "--------- ğŸ”– æ‹‰å–ä»£ç å‡†å¤‡æ„å»º ----------"
          git fetch
          echo $BRANCH ; git checkout $BRANCH
          echo "--------- ğŸ› ï¸ åˆ¶å“æ„å»ºä¸ç­¾å ----------"
          go mod tidy
          CGO_ENABLED=1 CGO_CFLAGS="-I$PWD\internal\datastore\sqlite\sqlite-vec" GOOS=darwin GOARCH=arm64  go build -o oadin -tags "development" -ldflags="-s -w"  cmd/cli/main.go
          codesign --verbose --force  --timestamp --options=runtime --sign "Developer ID Application: Digital China (China) Limited (US7ZG73N89)" oadin
          echo "--------- ğŸ“¦ å®‰è£…åŒ…æ„å»ºä¸ç­¾å ----------"
          mkdir -p pkgroot/oadin
          mv oadin pkgroot/oadin/oadin
          chmod +x installer/mac/preinstall
          chmod +x installer/mac/postinstall
          pkgbuild --identifier com.digitalchina.oadin --version "${VERSION}" --install-location /Users/Shared/Oadin --sign "Developer ID Installer: Digital China (China) Limited (US7ZG73N89)" --root pkgroot/Oadin --scripts ./installer/mac oadin.pkg
          echo "--------- ğŸ“¬ å®‰è£…åŒ…å…¬è¯ ----------"
          xcrun notarytool store-credentials "ci-profile" --apple-id "$APPLE_ID" --team-id "$APPLE_TEAM_ID"  --password "$APPLE_APP_SPECIFIC_PASSWORD"
          xcrun notarytool submit oadin.pkg --keychain-profile "ci-profile" --wait
          echo "--------- ğŸ“ é™„åŠ å…¬è¯ç¥¨æ® ----------"
          xcrun stapler staple oadin.pkg
          echo "--------- ğŸ”ï¸ éªŒç­¾ ----------"
          spctl --assess --type install --verbose=4 oadin.pkg
          echo "--------- ğŸ“ ç§»åŠ¨åˆ°å¾…ä¸Šä¼ æ–‡ä»¶å¤¹ ----------"
          mkdir -p upload
          mv oadin.pkg upload/${MAC_FILE_NAME}
          echo "========== ğŸ”§ Mac Build End =========="
      - name: upload nexus
        run: |
          echo "========== ğŸ”§ Mac Upload Begin =========="
          echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° Nexus ç§æœ --------"
          curl -v -u "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" --upload-file "/Users/dcone/WebstormProjects/oadin/upload/${MAC_FILE_NAME}" "http://${NEXUS_HOST_PORT}/repository/raw-hosted/intel-ai-pc/oadin/dist/mac/${MAC_FILE_NAME}"
          curl -v -u "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" --upload-file "/Users/dcone/WebstormProjects/oadin/upload/${MAC_FILE_NAME}" "http://${NEXUS_HOST_PORT}/repository/raw-hosted/intel-ai-pc/oadin/dist/mac/oadin-installer-latest.pkg"
          echo "========== ğŸ”§ Mac Upload End =========="

  build-win:
    name: Build Windows App
    runs-on: [ self-hosted, Windows, X64 ] # åŒ¹é… WIN-P1B0AOCK993
    steps:
      - name: Set ENV based on tag
        shell: powershell
        run: |
          "ENV=development" >> $env:GITHUB_ENV
      - name: Run build script on Windows
        run: |
          echo "========== ğŸ”§ Win Build Begin =========="
          echo "--------- ğŸ§¹ æ¸…é™¤æ—§æ–‡ä»¶ å‡†å¤‡çº¯å‡€ç¯å¢ƒ ----------"
          cd C:\Users\Administrator\WebstormProjects\oadin
          git reset --hard
          git clean -fd
          echo "--------- ğŸ”– æ‹‰å–ä»£ç å‡†å¤‡æ„å»º ----------"
          git fetch
          echo $env:BRANCH ; git checkout $env:BRANCH
          echo "--------- ğŸ› ï¸ åˆ¶å“æ„å»ºä¸ç­¾å ----------"
          go mod tidy
          $env:CGO_ENABLED= 1
          $env:GOOS= "windows"
          $env:GOARCH= "amd64"
          $env:CGO_CFLAGS= "-I$PWD\internal\datastore\sqlite\sqlite-vec"
          go build -o oadin.exe -tags "development" -ldflags="-s -w"  cmd/cli/main.go
          signtool sign /f C:\Users\Administrator\Desktop\u.cer /tr http://timestamp.digicert.com /td sha256 /fd sha256 /csp "eToken Base Cryptographic Provider" /k "[{{$($WIN_SIGN_PASSWORD)}}]=p11#942acfc7f5754f2e" "oadin.exe"
          echo "--------- ğŸ“¦ å®‰è£…åŒ…æ„å»ºä¸ç­¾å ----------"
          makensis.exe -DVERSION=$env:VERSION installer\win\oadin.nsi
          signtool sign /f C:\Users\Administrator\Desktop\u.cer /tr http://timestamp.digicert.com /td sha256 /fd sha256 /csp "eToken Base Cryptographic Provider" /k "[{{$($WIN_SIGN_PASSWORD)}}]=p11#942acfc7f5754f2e" "oadin-installer.exe"
          echo "--------- ğŸ“ ç§»åŠ¨åˆ°å¾…ä¸Šä¼ æ–‡ä»¶å¤¹ ----------"
          New-Item -ItemType Directory -Path "upload" -Force
          Move-Item -Path "oadin-installer.exe" -Destination "upload\$($env:WIN_FILE_NAME)" -Force
          echo "========== ğŸ”§ Win Build End =========="
      - name: upload nexus
        run: |
          echo "========== ğŸ”§ Win Upload Begin =========="
          echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° Nexus ç§æœ --------"
          cd C:\Users\Administrator\WebstormProjects\oadin
          curl.exe -v -u "$($env:NEXUS_USERNAME):$($env:NEXUS_PASSWORD)" --upload-file "upload/$($env:WIN_FILE_NAME)" "http://$($env:NEXUS_HOST_PORT)/repository/raw-hosted/intel-ai-pc/oadin/dist/win/$($env:WIN_FILE_NAME)"
          curl.exe -v -u "$($env:NEXUS_USERNAME):$($env:NEXUS_PASSWORD)" --upload-file "upload/$($env:WIN_FILE_NAME)" "http://$($env:NEXUS_HOST_PORT)/repository/raw-hosted/intel-ai-pc/oadin/dist/win/oadin-installer-latest.exe"
          echo "========== ğŸ”§ Win Upload End =========="
          

  notify-feishu:
    name: Notify Feishu
    runs-on: [ self-hosted, macOS, ARM64 ]
    needs:
      - build-mac
      - build-win
    steps:
      - name: Set ENV based on tag
        run: |
          echo "ENV=development" >> $GITHUB_ENV
      - name: Notify Feishu
        run: |
          echo "--------- ğŸ“¬ å‘å¸ƒé€šçŸ¥ ----------"
          cd /Users/dcone/WebstormProjects/oadin
          sh scripts/release-notice.sh
          echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
          cd /Users/dcone/WebstormProjects/oadin
          git reset --hard
          git clean -fd
          echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
          git checkout main