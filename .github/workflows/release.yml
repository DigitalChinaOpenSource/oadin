name: Build App on Self-Hosted Runners

on:
  push:
    tags:
      - '*' # ä»…åœ¨ç‰ˆæœ¬æ ‡ç­¾æ¨é€æ—¶è§¦å‘

env:
  CI_COMMIT_TAG: "${{ github.ref_name }}"
  MAC_FILE_NAME: "oadin-installer-${{ github.ref_name }}.pkg"
  WIN_FILE_NAME: "oadin-installer-${{ github.ref_name }}.exe"
  NEXUS_HOST_PORT: ${{ secrets.NEXUS_HOST_PORT }}
  NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
  NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}

jobs:
  build-mac:
    name: Build macOS App
    runs-on: [ self-hosted, macOS, ARM64 ] # åŒ¹é… aiwenxuedeMac-mini
    steps:
      - name: Set ENV based on tag
        run: |
          if [[ "${{ github.ref_name }}" == test* ]]; then
            echo "ENV=development" >> $GITHUB_ENV
          else
            echo "ENV=production" >> $GITHUB_ENV
          fi
      - name: Run build script on Mac
        run: |
          echo "$ENV"
          echo "========== ğŸ”§ Mac Build Begin =========="
          echo "--------- ğŸ§¹ æ¸…é™¤æ—§æ–‡ä»¶ å‡†å¤‡çº¯å‡€ç¯å¢ƒ ----------"
          cd /Users/dcone/WebstormProjects/oadin/
          git reset --hard
          git clean -fd
          echo "--------- ğŸ”– æ‹‰å–ä»£ç å‡†å¤‡æ„å»º ----------"
          git fetch
          echo $CI_COMMIT_TAG ; git checkout $CI_COMMIT_TAG
          echo "--------- ğŸ› ï¸ åˆ¶å“æ„å»ºä¸ç­¾å ----------"
          go mod tidy
          echo "$ENV active"
          
          # æ„å»ºä¸»ç¨‹åº
          CGO_ENABLED=1 CGO_CFLAGS="-I$PWD\internal\datastore\sqlite\sqlite-vec" GOOS=darwin GOARCH=arm64  go build -o oadin -tags "$ENV" -ldflags="-s -w"  cmd/cli/main.go
          
          # ğŸ”¥ æ·»åŠ ï¼šæ„å»ºæ‰˜ç›˜ç¨‹åº
          CGO_ENABLED=1 GOOS=darwin GOARCH=arm64 go build -o oadin-tray trayapp/main.go
          
          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          if [ ! -f "oadin" ]; then
              echo "âŒ oadin not found"
              exit 1
          fi
          if [ ! -f "oadin-tray" ]; then
              echo "âŒ oadin-tray not found"
              exit 1
          fi
          echo "âœ… Both oadin and oadin-tray built successfully"
          
          # ğŸ”¥ ç”Ÿæˆ macOS åº”ç”¨å›¾æ ‡ (ICNS)
          echo "--------- ğŸ¨ ç”Ÿæˆ macOS åº”ç”¨å›¾æ ‡ ----------"
          if [ -f "tray/icon/oadin-icon.png" ]; then
              # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾ä¸åŒå°ºå¯¸çš„å›¾æ ‡
              mkdir -p tmp_iconset.iconset
              
              # ç”Ÿæˆä¸åŒå°ºå¯¸çš„å›¾æ ‡ (ä½¿ç”¨ sips å‘½ä»¤)
              sips -z 16 16     tray/icon/oadin-icon.png --out tmp_iconset.iconset/icon_16x16.png
              sips -z 32 32     tray/icon/oadin-icon.png --out tmp_iconset.iconset/icon_16x16@2x.png
              sips -z 32 32     tray/icon/oadin-icon.png --out tmp_iconset.iconset/icon_32x32.png
              sips -z 64 64     tray/icon/oadin-icon.png --out tmp_iconset.iconset/icon_32x32@2x.png
              sips -z 128 128   tray/icon/oadin-icon.png --out tmp_iconset.iconset/icon_128x128.png
              sips -z 256 256   tray/icon/oadin-icon.png --out tmp_iconset.iconset/icon_128x128@2x.png
              sips -z 256 256   tray/icon/oadin-icon.png --out tmp_iconset.iconset/icon_256x256.png
              sips -z 512 512   tray/icon/oadin-icon.png --out tmp_iconset.iconset/icon_256x256@2x.png
              sips -z 512 512   tray/icon/oadin-icon.png --out tmp_iconset.iconset/icon_512x512.png
              sips -z 1024 1024 tray/icon/oadin-icon.png --out tmp_iconset.iconset/icon_512x512@2x.png
              
              # ç”Ÿæˆ ICNS æ–‡ä»¶
              iconutil -c icns tmp_iconset.iconset -o installer/mac/oadin.icns
              
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -rf tmp_iconset.iconset
              
              if [ -f "installer/mac/oadin.icns" ]; then
                  echo "âœ… ICNS å›¾æ ‡ç”ŸæˆæˆåŠŸ"
              else
                  echo "âš ï¸ ICNS å›¾æ ‡ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡"
              fi
          else
              echo "âš ï¸ æœªæ‰¾åˆ° PNG å›¾æ ‡æ–‡ä»¶ï¼Œè·³è¿‡ ICNS ç”Ÿæˆ"
          fi
          
          # ç­¾åä¸»ç¨‹åº
          codesign --verbose --force  --timestamp --options=runtime --sign "Developer ID Application: Digital China (China) Limited (US7ZG73N89)" oadin
          
          # ç­¾åæ‰˜ç›˜ç¨‹åº
          codesign --verbose --force  --timestamp --options=runtime --sign "Developer ID Application: Digital China (China) Limited (US7ZG73N89)" oadin-tray
          
          echo "--------- ğŸ“¦ åˆ›å»º .app åº”ç”¨ç¨‹åºåŒ… ----------"
          # åˆ›å»º .app ç›®å½•ç»“æ„
          mkdir -p "Oadin.app/Contents/MacOS"
          mkdir -p "Oadin.app/Contents/Resources"
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp oadin "Oadin.app/Contents/MacOS/"
          cp oadin-tray "Oadin.app/Contents/MacOS/"
          
          # å¤åˆ¶å›¾æ ‡æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "installer/mac/oadin.icns" ]; then
              cp installer/mac/oadin.icns "Oadin.app/Contents/Resources/"
          fi
          
          # åˆ›å»º Info.plist
          cat > "Oadin.app/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleDisplayName</key>
              <string>Oadin</string>
              <key>CFBundleExecutable</key>
              <string>oadin-tray</string>
              <key>CFBundleIconFile</key>
              <string>oadin.icns</string>
              <key>CFBundleIdentifier</key>
              <string>com.digitalchina.oadin</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>Oadin</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${CI_COMMIT_TAG}</string>
              <key>CFBundleVersion</key>
              <string>${CI_COMMIT_TAG}</string>
              <key>LSMinimumSystemVersion</key>
              <string>11.0</string>
              <key>LSUIElement</key>
              <true/>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSHumanReadableCopyright</key>
              <string>Copyright Â© 2024 Digital China. All rights reserved.</string>
          </dict>
          </plist>
          EOF
          
          # ç­¾å .app
          codesign --verbose --force --timestamp --options=runtime --sign "Developer ID Application: Digital China (China) Limited (US7ZG73N89)" "Oadin.app"
          
          echo "--------- ğŸ“¦ å®‰è£…åŒ…æ„å»ºä¸ç­¾å ----------"
          mkdir -p pkgroot/Applications
          mv Oadin.app pkgroot/Applications/
          chmod +x installer/mac/preinstall
          chmod +x installer/mac/postinstall
          pkgbuild --identifier com.digitalchina.oadin --version "${CI_COMMIT_TAG}" --install-location /Applications --sign "Developer ID Installer: Digital China (China) Limited (US7ZG73N89)" --root pkgroot --scripts ./installer/mac oadin.pkg
          echo "--------- ğŸ“¬ å®‰è£…åŒ…å…¬è¯ ----------"
          xcrun notarytool store-credentials "ci-profile" --apple-id "$APPLE_ID" --team-id "$APPLE_TEAM_ID"  --password "$APPLE_APP_SPECIFIC_PASSWORD"
          xcrun notarytool submit oadin.pkg --keychain-profile "ci-profile" --wait
          echo "--------- ğŸ“ é™„åŠ å…¬è¯ç¥¨æ® ----------"
          xcrun stapler staple oadin.pkg
          echo "--------- ğŸ”ï¸ éªŒç­¾ ----------"
          spctl --assess --type install --verbose=4 oadin.pkg
          echo "--------- ğŸ“ ç§»åŠ¨åˆ°å¾…ä¸Šä¼ æ–‡ä»¶å¤¹ ----------"
          mkdir -p upload
          mv oadin.pkg upload/${MAC_FILE_NAME}
          echo "========== ğŸ”§ Mac Build End =========="
      - name: upload nexus
        if: startsWith(github.ref_name, 'test')
        run: |
          echo "========== ğŸ”§ Mac Upload Begin =========="
          echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° Nexus ç§æœ --------"
          curl -v -u "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" --upload-file "/Users/dcone/WebstormProjects/oadin/upload/${MAC_FILE_NAME}" "http://${NEXUS_HOST_PORT}/repository/raw-hosted/intel-ai-pc/oadin/releases/mac/${MAC_FILE_NAME}"
          curl -v -u "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" --upload-file "/Users/dcone/WebstormProjects/oadin/upload/${MAC_FILE_NAME}" "http://${NEXUS_HOST_PORT}/repository/raw-hosted/intel-ai-pc/oadin/releases/mac/oadin-installer-latest.pkg"
          echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
          cd /Users/dcone/WebstormProjects/oadin
          git reset --hard
          git clean -fd
          echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
          git checkout main
          git tag -d $CI_COMMIT_TAG
          echo "========== ğŸ”§ Mac Upload End =========="
      - name: upload oss
        if: ${{ !startsWith(github.ref_name, 'test') }}
        run: |
          echo "========== ğŸ”§ Mac Upload Begin =========="
          echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° é˜¿é‡Œäº‘ OSS --------"
          cd /Users/dcone/WebstormProjects/oadin/upload
          ossutil cp "${MAC_FILE_NAME}" "oss://smartvision-aipc/oadin/releases/macos/${MAC_FILE_NAME}" --force
          ossutil cp "${MAC_FILE_NAME}" "oss://smartvision-aipc/oadin/releases/macos/oadin-installer-latest.pkg" --force
          echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
          git reset --hard
          git clean -fd
          echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
          git checkout main
          git tag -d $CI_COMMIT_TAG
          echo "--------- â™»ï¸ åˆ·æ–°CND ----------"
          aliyun cdn RefreshObjectCaches --ObjectPath "https://oss-aipc.dcclouds.com/oadin/releases/macos/oadin-installer-latest.pkg" --ObjectType File
          echo "========== ğŸ”§ Mac Upload End =========="

  build-win:
    name: Build Windows App
    runs-on: [ self-hosted, Windows, X64 ] # åŒ¹é… WIN-P1B0AOCK993
    steps:
      - name: Set ENV based on tag
        shell: powershell
        run: |
          if ("${{ github.ref_name }}" -like "test*") {
            "ENV=development" >> $env:GITHUB_ENV
          } else {
            "ENV=production" >> $env:GITHUB_ENV
          }
      - name: Run build script on Windows
        run: |
          echo "========== ğŸ”§ Win Build Begin =========="
          echo "--------- ğŸ§¹ æ¸…é™¤æ—§æ–‡ä»¶ å‡†å¤‡çº¯å‡€ç¯å¢ƒ ----------"
          cd C:\Users\Administrator\WebstormProjects\oadin
          git reset --hard
          git clean -fd
          echo "--------- ğŸ”– æ‹‰å–ä»£ç å‡†å¤‡æ„å»º ----------"
          git fetch
          echo $env:CI_COMMIT_TAG ; git checkout $env:CI_COMMIT_TAG
          echo "--------- ğŸ› ï¸ åˆ¶å“æ„å»ºä¸ç­¾å ----------"
          go mod tidy
          $env:CGO_ENABLED=1
          $env:GOOS="windows"
          $env:GOARCH="amd64"
          $env:CGO_CFLAGS="-I$PWD\internal\datastore\sqlite\sqlite-vec"
          
          # æ„å»ºä¸»ç¨‹åº
          go build -o oadin.exe -tags "$env:ENV" -ldflags="-s -w" cmd/cli/main.go
          
          # ğŸ”¥ å…³é”®ä¿®å¤ï¼šç¡®ä¿å›¾æ ‡æ–‡ä»¶åœ¨æ­£ç¡®ä½ç½®ä¾›æ„å»ºä½¿ç”¨
          Write-Host "Preparing icon file for tray app build..."
          if (!(Test-Path "tray\\icon\\oadin-icon.ico")) {
              if (Test-Path "tray\\icon\\oadin-icon.ico") {
                  Copy-Item "tray\\icon\\oadin-icon.ico" "tray\\icon\\oadin-icon.ico" -Force
                  Write-Host "â¡ï¸ Prepared tray\\icon\\oadin-icon.ico from ä¸­æ–‡æ–‡ä»¶å"
              } else {
                  Write-Error "âŒ No icon file found for embedding"
                  exit 1
              }
          } else {
              Write-Host "âœ… tray\\icon\\oadin-icon.ico already exists"
          }
          
          # éªŒè¯å›¾æ ‡æ–‡ä»¶ç¡®å®å­˜åœ¨
          if (Test-Path "tray\\icon\\oadin-icon.ico") {
              $iconSize = (Get-Item "tray\\icon\\oadin-icon.ico").Length
              Write-Host "âœ… Icon file verified: tray\\icon\\oadin-icon.ico ($iconSize bytes)"
          } else {
              Write-Error "âŒ Icon file missing after preparation"
              exit 1
          }
          
          # åªä½¿ç”¨ goversioninfo ç”Ÿæˆèµ„æºæ–‡ä»¶
          Write-Host "Installing goversioninfo tool..."
          go install github.com/josephspurrier/goversioninfo/cmd/goversioninfo@latest
          
          if (Test-Path "trayapp\\versioninfo.json") {
              Write-Host "Generating Windows version info and icon..."
              Push-Location "trayapp"
              
              # ä½¿ç”¨å‡†å¤‡å¥½çš„å›¾æ ‡æ–‡ä»¶
              if (Test-Path "..\\tray\\icon\\oadin-icon.ico") {
                  Write-Host "Found icon file, generating resource..."
                  & "$env:GOPATH\\bin\\goversioninfo.exe" -icon "..\\tray\\icon\\oadin-icon.ico"
                  
                  if (Test-Path "resource.syso") {
                      $fileSize = (Get-Item "resource.syso").Length
                      Write-Host "âœ… Windows resource file with icon generated successfully (size: $fileSize bytes)"
                      
                      # éªŒè¯ resource.syso åŒ…å«æ•°æ®
                      if ($fileSize -gt 1000) {
                          Write-Host "âœ… Resource file size looks good, likely contains icon data"
                      } else {
                          Write-Host "âš ï¸ Resource file seems small, may not contain icon properly"
                      }
                  } else {
                      Write-Host "âš ï¸ Failed to generate resource file"
                  }
              } else {
                  Write-Host "âš ï¸ Icon file not found at: ..\\tray\\icon\\oadin-icon.ico"
                  & "$env:GOPATH\\bin\\goversioninfo.exe"
              }
              
              Pop-Location
          } else {
              Write-Host "âš ï¸ versioninfo.json not found, building without version info"
          }
          
          # éªŒè¯ resource.syso å­˜åœ¨åå†æ„å»º
          if (Test-Path "trayapp\\resource.syso") {
              $resourceSize = (Get-Item "trayapp\\resource.syso").Length
              Write-Host "âœ… Resource file ready for build (size: $resourceSize bytes)"
          } else {
              Write-Host "âš ï¸ No resource.syso found, building without embedded resources"
          }
          
          # æ„å»ºæ‰˜ç›˜ç¨‹åºï¼ˆä¼šè‡ªåŠ¨åŒ…å« resource.sysoï¼‰
          Write-Host "Building tray application..."
          go build -o oadin-tray.exe trayapp/main.go
          
          # éªŒè¯æ„å»ºçš„ EXE æ–‡ä»¶å¤§å°
          if (Test-Path "oadin-tray.exe") {
              $exeSize = (Get-Item "oadin-tray.exe").Length
              Write-Host "âœ… oadin-tray.exe built successfully (size: $exeSize bytes)"
              
              # ä½¿ç”¨ PowerShell æ£€æŸ¥ EXE æ˜¯å¦åŒ…å«å›¾æ ‡èµ„æº
              try {
                  $assembly = [System.Reflection.Assembly]::LoadFile((Resolve-Path "oadin-tray.exe").Path)
                  Write-Host "âœ… EXE file can be loaded as assembly"
              } catch {
                  Write-Host "â„¹ï¸ EXE file inspection: $_"
              }
          }
          
          # ä¸è¦ç«‹å³åˆ é™¤ resource.sysoï¼Œä¿ç•™ç”¨äºè°ƒè¯•
          if (Test-Path "trayapp\\resource.syso") {
              Write-Host "â„¹ï¸ Keeping resource.syso for verification"
          }
          
          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          if (-not (Test-Path "oadin.exe")) { 
              Write-Error "âŒ oadin.exe not found" 
              exit 1 
          }
          if (-not (Test-Path "oadin-tray.exe")) { 
              Write-Error "âŒ oadin-tray.exe not found" 
              exit 1 
          }
          Write-Host "âœ… Both oadin.exe and oadin-tray.exe built successfully"
          
          # ç­¾åä¸»ç¨‹åº
          signtool sign /f C:\Users\Administrator\Desktop\u.cer /tr http://timestamp.digicert.com /td sha256 /fd sha256 /csp "eToken Base Cryptographic Provider" /k "[{{$($WIN_SIGN_PASSWORD)}}]=p11#942acfc7f5754f2e" "oadin.exe"
          
          echo "--------- ğŸ“¦ å®‰è£…åŒ…æ„å»ºä¸ç­¾å ----------"
          
          # æ˜¾ç¤ºå½“å‰ç›®å½•å’Œæ–‡ä»¶ä¿¡æ¯ç”¨äºè°ƒè¯•
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Files in root directory:"
          Get-ChildItem -Name "*.exe" | ForEach-Object { Write-Host "  $_" }
          
          # éªŒè¯ installer\win ç›®å½•å­˜åœ¨
          if (-not (Test-Path "installer\win")) {
              Write-Error "âŒ installer\win directory not found"
              exit 1
          }
          
          # æ–¹æ¡ˆï¼šå°†æ–‡ä»¶å¤åˆ¶åˆ° installer\win ç›®å½•ä»¥ç¡®ä¿ NSIS èƒ½æ‰¾åˆ°
          Write-Host "Copying files to installer\win directory..."
          Copy-Item "oadin.exe" "installer\win\" -Force
          if (Test-Path "oadin-tray.exe") {
              Copy-Item "oadin-tray.exe" "installer\win\" -Force
              Write-Host "âœ… oadin-tray.exe copied to installer\win"
          } else {
              Write-Host "âš ï¸ oadin-tray.exe not found, skipping copy"
          }
          
          # å¤åˆ¶å›¾æ ‡æ–‡ä»¶åˆ° installer\win ç›®å½•ï¼ˆé‡å‘½åé¿å…ä¸­æ–‡ç¼–ç é—®é¢˜ï¼‰
          if (Test-Path "tray\\icon\\oadin-icon.ico") {
              # é‡å‘½åä¸ºçº¯ASCIIæ–‡ä»¶å
              Copy-Item "tray\\icon\\oadin-icon.ico" "installer\\win\\oadin-icon.ico" -Force
              Write-Host "âœ… Icon file copied and renamed to oadin-icon.ico"
          } else {
              Write-Host "âš ï¸ Icon file not found at tray\\icon\\oadin-icon.ico"
          }
          
          # éªŒè¯æ–‡ä»¶å¤åˆ¶æˆåŠŸ
          Write-Host "Files in installer\win directory:"
          Get-ChildItem "installer\win\" -Name "*.exe" | ForEach-Object { Write-Host "  $_" }
          Get-ChildItem "installer\win\" -Name "*.ico" | ForEach-Object { Write-Host "  $_" }

          $nsisPath = "installer\win\oadin.nsi"
          if (Test-Path $nsisPath) {
            Write-Host "Found NSIS script at: $nsisPath"
            $content = Get-Content $nsisPath -Raw

            $content = $content -replace '(?m)^\s*!pragma.*\r?\n',''

            $content = $content -replace '(?m)^\s*Icon\s+\".*\"\s*$',          'Icon "oadin-icon.ico"'
            $content = $content -replace '(?m)^\s*UninstallIcon\s+\".*\"\s*$', 'UninstallIcon "oadin-icon.ico"'


            $content = $content -replace '\.\.\\\.\.\\tray\\icon\\OADIN-[^"]+\.ico','oadin-icon.ico'

            [System.IO.File]::WriteAllText((Resolve-Path $nsisPath).Path, $content, [System.Text.Encoding]::GetEncoding(1252))
            Write-Host "âœ… NSIS script sanitized (no pragma, ASCII icon path)"
            
            Write-Host "----- NSIS script first 20 lines -----"
            Get-Content $nsisPath -First 20 | ForEach-Object -Begin { $i = 1 } -Process {
              "{0,3}: {1}" -f $i, $_ | Write-Host
              $i++
            }
          } else {
            Write-Error "âŒ NSIS script not found at: $nsisPath"
            exit 1
          }
          
          # è¿›å…¥ installer\win ç›®å½•è¿è¡Œ NSIS
          Push-Location "installer\win"
          Write-Host "Running NSIS from: $(Get-Location)"
          
          makensis.exe -DVERSION=$env:CI_COMMIT_TAG oadin.nsi
          $nsisExitCode = $LASTEXITCODE
          
          if ($nsisExitCode -ne 0) {
              Write-Error "âŒ NSIS build failed with exit code: $nsisExitCode"
              Pop-Location
              exit 1
          }
          
          # éªŒè¯å®‰è£…åŒ…æ˜¯å¦åœ¨å½“å‰ç›®å½•ç”Ÿæˆ
          if (Test-Path "oadin-installer.exe") {
              Write-Host "âœ… oadin-installer.exe found in installer\win"
              # ç§»åŠ¨åˆ°æ ¹ç›®å½•
              Move-Item "oadin-installer.exe" "..\..\oadin-installer.exe" -Force
              Pop-Location
          } else {
              Write-Error "âŒ oadin-installer.exe not found in installer\win"
              Pop-Location
              exit 1
          }
          
          # éªŒè¯å®‰è£…åŒ…æ˜¯å¦æˆåŠŸç§»åŠ¨åˆ°æ ¹ç›®å½•
          if (-not (Test-Path "oadin-installer.exe")) { 
              Write-Error "âŒ oadin-installer.exe not found in root directory" 
              exit 1 
          }
          Write-Host "âœ… oadin-installer.exe created successfully in root directory"
          
          signtool sign /f C:\Users\Administrator\Desktop\u.cer /tr http://timestamp.digicert.com /td sha256 /fd sha256 /csp "eToken Base Cryptographic Provider" /k "[{{$($WIN_SIGN_PASSWORD)}}]=p11#942acfc7f5754f2e" "oadin-installer.exe"
          echo "--------- ğŸ“ ç§»åŠ¨åˆ°å¾…ä¸Šä¼ æ–‡ä»¶å¤¹ ----------"
          New-Item -ItemType Directory -Path "upload" -Force
          Move-Item -Path "oadin-installer.exe" -Destination "upload\$($env:WIN_FILE_NAME)" -Force
          echo "========== ğŸ”§ Win Build End =========="
      - name: upload nexus
        if: startsWith(github.ref_name, 'test')
        run: |
          echo "========== ğŸ”§ Win Upload Begin =========="
          echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° Nexus ç§æœ --------"
          cd C:\Users\Administrator\WebstormProjects\oadin
          curl.exe -v -u "$($env:NEXUS_USERNAME):$($env:NEXUS_PASSWORD)" --upload-file "upload/$($env:WIN_FILE_NAME)" "http://$($env:NEXUS_HOST_PORT)/repository/raw-hosted/intel-ai-pc/oadin/releases/win/$($env:WIN_FILE_NAME)"
          curl.exe -v -u "$($env:NEXUS_USERNAME):$($env:NEXUS_PASSWORD)" --upload-file "upload/$($env:WIN_FILE_NAME)" "http://$($env:NEXUS_HOST_PORT)/repository/raw-hosted/intel-ai-pc/oadin/releases/win/oadin-installer-latest.exe"
          echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
          git reset --hard
          git clean -fd
          echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
          git checkout main
          git tag -d $env:CI_COMMIT_TAG
          echo "========== ğŸ”§ Win Upload End =========="
      - name: upload oss
        if: ${{ !startsWith(github.ref_name, 'test') }}
        run: |
          echo "========== ğŸ”§ Win Upload Begin =========="
          echo "-------- ğŸ“¤ ä¸Šä¼ åˆ° é˜¿é‡Œäº‘ OSS --------"
          cd C:\Users\Administrator\WebstormProjects\oadin
          ossutil cp "upload/$($env:WIN_FILE_NAME)" "oss://smartvision-aipc/oadin/releases/windows/$($env:WIN_FILE_NAME)" --force
          ossutil cp "upload/$($env:WIN_FILE_NAME)" "oss://smartvision-aipc/oadin/releases/windows/oadin-installer-latest.exe" --force
          echo "--------- ğŸ§¹ ç¯å¢ƒæ¸…ç† ----------"
          git reset --hard
          git clean -fd
          echo "--------- ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°tag ----------"
          git checkout main
          git tag -d $env:CI_COMMIT_TAG
          echo "--------- â™»ï¸ åˆ·æ–°CND ----------"
          aliyun cdn RefreshObjectCaches --ObjectPath "https://oss-aipc.dcclouds.com/oadin/releases/windows/oadin-installer-latest.exe" --ObjectType File
          echo "========== ğŸ”§ Win Upload End =========="

      - name: Notify Feishu
        shell: powershell
        run: |
            $uri = "${{ secrets.NOTIFY_SECRET }}"
            $tag = "${{ github.ref_name }}"
            
            # åˆ¤æ–­ç¯å¢ƒå’Œä¸‹è½½è·¯å¾„
            if ($tag -like "test*") {
              $envType = "æµ‹è¯•ç¯å¢ƒ"
              $macUrl = "http://${{ env.NEXUS_HOST_PORT }}/repository/raw-hosted/intel-ai-pc/oadin/releases/mac/${{ env.MAC_FILE_NAME }}"
              $winUrl = "http://${{ env.NEXUS_HOST_PORT }}/repository/raw-hosted/intel-ai-pc/oadin/releases/win/${{ env.WIN_FILE_NAME }}"
            } else {
              $envType = "ç”Ÿäº§ç¯å¢ƒ"
              $macUrl = "https://oss-aipc.dcclouds.com/oadin/releases/macos/${{ env.MAC_FILE_NAME }}"
              $winUrl = "https://oss-aipc.dcclouds.com/oadin/releases/windows/${{ env.WIN_FILE_NAME }}"
            }
            $bodyObj = @{
              msg_type = 'post'
              content = @{
                post = @{
                  zh_cn = @{
                    title = "ğŸ‰ [$envType] å®‰è£…åŒ…ä¸Šä¼ æˆåŠŸ"
                    content = @(
                      @(
                        @{ tag = "at"; user_id = "a37571869425831e1d434f333a9ca2ba34eaae8b" },
                        @{ tag = "text"; text = "OADIN æ„å»ºå·²å®Œæˆï¼" }
                      ),
                      @(
                        @{ tag = "text"; text = "ç¯å¢ƒ: " },
                        @{ tag = "text"; text = "$envType"; bold = $true }
                      ),
                      @(
                        @{ tag = "text"; text = "Tag: " },
                        @{ tag = "text"; text = "$tag"; bold = $true }
                      ),
                      @(
                        @{ tag = "text"; text = "Macä¸‹è½½: " },
                        @{ tag = "a"; href = "$macUrl"; text = "ç‚¹å‡»ä¸‹è½½" }
                      ),
                      @(
                        @{ tag = "text"; text = "Winä¸‹è½½: " },
                        @{ tag = "a"; href = "$winUrl"; text = "ç‚¹å‡»ä¸‹è½½" }
                      ),
                      @(
                        @{ tag = "text"; text = "â° æ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" }
                      )
                    )
                  }
                }
              }
            }
            $json = $bodyObj | ConvertTo-Json -Depth 10
            $utf8NoBomEncoding = New-Object System.Text.UTF8Encoding($false)
            $body = $utf8NoBomEncoding.GetBytes($json)
            Invoke-RestMethod -Uri $uri -Method Post -ContentType "application/json; charset=utf-8" -Body $body